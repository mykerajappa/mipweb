@model IEnumerable<Expense>
@{
    ViewBag.Title = "Expenses";
}
<style>
    thead tr {
        position: sticky;
        top: 0;
        background-color: #212529; /* Bootstrap table-dark bg */
        color: white;
        z-index: 3;
    }

    tfoot tr {
        position: sticky;
        bottom: 0;
        background-color: #f8f9fa; /* Bootstrap table-light bg */
        box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        z-index: 2;
    }

    /* Sticky Amount Column */
    .amount-col {
        position: sticky;
        right: 0;
        background-color: inherit; /* Keep same row background */
        z-index: 4;
    }

    /* Ensure footer total also stays over other cells */
    tfoot .amount-col {
        z-index: 5;
    }
</style>
<h2>Expenses</h2>
<div class="mb-3 text-end">
    <a asp-action="Create" asp-controller="Expense" class="btn btn-primary">
        New Expense
    </a>
</div>


<form method="get" class="row g-3 mb-4">
    <div class="col-md-2">
        <label class="form-label">Month</label>
        <select name="month" class="form-select" as>
            <option value="">All</option>
            @for (int m = 1; m <= 12; m++)
            {
                var selected = (ViewBag.SelectedMonth != null && (int)ViewBag.SelectedMonth == m) ? "selected" : "";
@removeTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
                <option value="@m" selected="@selected">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)</option>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
            }
        </select>
    </div>

    <div class="col-md-2">
        <label class="form-label">Year</label>
        <select name="year" class="form-select">
            <option value="">All</option>
            @for (int y = DateTime.Now.Year; y >= DateTime.Now.Year - 5; y--)
            {
                var isSelected = (ViewBag.SelectedYear != null && (int)ViewBag.SelectedYear == y) ? "selected" : "";
@removeTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
                <option value="@y" selected="@isSelected">@y</option>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
            }
        </select>
    </div>

    <div class="col-md-3">
        <label class="form-label">Category</label>
        <select name="categoryId" class="form-select">
            <option value="">All</option>
            @foreach (var c in ViewBag.Categories)
            {
                <option value="@c.ExpenseCategoryID">@c.CategoryName</option>
            }
        </select>
    </div>

    <div class="col-md-3">
        <label class="form-label">Partner</label>
        <select name="partnerUserId" class="form-select">
            <option value="">All</option>
            @foreach (var p in ViewBag.Partners)
            {
                <option value="@p.Id">@p.Name</option>
            }
        </select>
    </div>

    <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
    </div>
</form>

<table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount</th>
            <th>Paid By</th>
            <th>Entered By</th>
            <th>Entered At</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var e in Model)
        {
            <tr>
                <td>@e.ExpenseDate.ToString("dd-MMM-yyyy")</td>
                <td>@e.Category?.CategoryName</td>
                <td>@e.Description</td>
                <td class="text-end amount-col">@e.Amount.ToString("0.00")</td>
                <td>@(e.PartnerUser?.Name ?? "School Funds")</td>
                <td>@e.CreatedByUser?.Name</td>
                <td>@e.CreatedAt.ToString("dd-MMM-yyyy HH:mm")</td>
            </tr>
        }
    </tbody>
    <tfoot>
        <tr class="fw-bold table-light">
            <td colspan="3" class="text-end">Total</td>
            <td class="text-end amount-col">@ViewBag.TotalAmount.ToString("N2")</td>
            <td></td>
        </tr>
    </tfoot>
</table>
